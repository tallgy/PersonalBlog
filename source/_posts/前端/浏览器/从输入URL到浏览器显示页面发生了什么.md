---
title: 从输入URL到浏览器显示页面发生了什么
date: 2023-07-02 15:16:12
tags:
 - 浏览器
categories:
 - 浏览器
---


# 从输入URL到浏览器显示页面发生了什么

![Alt text](./%E4%BB%8E%E8%BE%93%E5%85%A5URL%E5%88%B0%E6%B5%8F%E8%A7%88%E5%99%A8%E6%98%BE%E7%A4%BA%E9%A1%B5%E9%9D%A2%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/image.png)

## 从 url 到 ip 的转换

首先就是，我们会将浏览器输入的url，通过 dns协议，将 域名解析为 IP 。这里 dns 协议是基于 udp 来实现的。
如果你的输入不是网址，而是一串关键词，浏览器就知道你是要搜索于是就会使用默认配置的搜索引擎来查询。

### DNS 协议

DNS解析流程分为递归查询和迭代查询，递归查询是以本地名称服务器为中心查询， 递归查询是默认方式，迭代查询是以DNS客户端，也就是客户机器为中心查询。其实DNS客户端和本地名称服务器是递归，而本地名称服务器和其他名称服务器之间是迭代。
个人猜测使用了迭代和递归两个的原因是：域名服务器为了省下被占用的时间，所以需要使用迭代进行查询。

dns 使用的是 udp 链接，因为 udp 快速，不需要进行三次握手。


## IP 访问

同一个IP访问请求，一次最多只能发送6个tcp连接请求


## tcp 连接，三次握手



## http 请求


![Alt text](./%E4%BB%8E%E8%BE%93%E5%85%A5URL%E5%88%B0%E6%B5%8F%E8%A7%88%E5%99%A8%E6%98%BE%E7%A4%BA%E9%A1%B5%E9%9D%A2%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/image.png)



## 网络线程获取到数据

检查数据是否安全。



## 渲染过程

### 生成DOM树

浏览器进程通过 ipc 管道将数据传递给渲染器进程。
渲染器进程将得到的HTML数据解析构造成DOM树。
HTML 通过 词法分析器，生成 DOM 树，
对于其中遇到的 图片、css、js 等资源时。
对于 图片、css 资源通过网络下载或者缓存中直接加载，这些不会阻塞 HTML 的解析。
但是如果遇到了 js 资源，那么就会转而加载并执行js。（因为 js 可以修改当前页面的DOM结构，所以我们需要等待 js 执行完成。这也就是为什么我们需要将 js 放在合适的位置，或者通过使用 async、defer 属性来异步加载 js。）




### 生成 cssom 树

原本情况，DOM 和 CSSOM 的生成是同步进行的，但是如果出现了 JavaScript 标签，那么就会出现一个等待的情况。具体是 CSSOM 大于 js 大于 DOM 。
这里的原因是，JavaScript 可以操作 DOM 和 cssom ，但是 cssom 如果不解析完成无法使用，所以此时就需要等待 cssom 的解析完成，然后才能执行 js。 js 可以操作 DOM，但是因为 js 操作DOM，可以不需要等待 DOM解析完成，所以此时就需要 DOM 等待 js 执行，因为 避免出现 js 操作了 DOM 影响了原来的DOM结构的变化。



### 合并生成 layout tree

通过 DOM 树和 cssom  树，合并生成 layout tree，
比如 css 控制了元素的展示，以及 伪元素的产生。


### 绘制

#### 渲染层 和 合成层

每一个元素有自身的 layout object 信息。根据其内部信息，将其分为不同的渲染层级。

在层叠上下文中，其子级层叠上下文的 z-index 值只在父级中才有意义。子级层叠上下文被自动视为父级层叠上下文的一个独立单元。

层叠上下文：
https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_positioned_layout/Understanding_z-index/Stacking_context


渲染层是为了保证页面元素的正确顺序，合成层是为了减少渲染的开销
不同的合成层，在 repaint 的时候，是不会影响到其他合成层的，所以可以提升 DOM 更新的性能。


#### 栅格化

浏览器分别对不同的渲染层，进行栅格化，同时将图片分成很多图块，进行渲染。渲染完成之后再通过合成器线程合并为一个页面帧展示。