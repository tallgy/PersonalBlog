---
title: 图片懒加载的实现
date: 2023-07-31 19:08:53
tags: 
- 浏览器
categories:
- 浏览器
---

# 浏览器图片懒加载

图片懒加载主要是 src 
用 data-src 去存储真正显示的值，然后进行替换。
实现了懒加载的目的


## IntersectionObserver 方法

创建一个新的 IntersectionObserver 对象，当其监听到目标元素的可见部分（的比例）超过了一个或多个阈值（threshold）时，会执行指定的回调函数。

```JavaScript

// 创建的图片列表。
const createImgs = (nums = 50) => {
  const fragment = new DocumentFragment();
  for(let i=0; i<nums; i++) {
    const img = document.createElement('img');
    img.src = 'default.jpg';
    img['data-src'] = 'R-C.jpg';
    img.className = `box img${i}`;
    fragment.appendChild(img);
  }

  return fragment;
}

const f = createImgs();
boxDom.appendChild(f);

// 开始监听
const createObserver = (imgs) => {
  const intersectionObserver = new IntersectionObserver(entriesCallback);

  imgs.forEach(value => {
    value.nodeType === 1 && intersectionObserver.observe(value);
  })

  function entriesCallback (entries) {
    // 如果 intersectionRatio 为 0，则目标在视野外，
    entries.forEach(({intersectionRatio, target}) => {
      // 如果在页面里面，ratio > 0 
      if (intersectionRatio > 0) {
        target.src = target['data-src'];
        // 执行一次，说明了已经取消监听
        intersectionObserver.unobserve(target)
      }
    })
  }
}

createObserver(boxDom.childNodes)

```


## getBoundingClientRect

返回值是一个 DOMRect 对象，是包含整个元素的最小矩形（包括 padding 和 border-width）。该对象使用 left、top、right、bottom、x、y、width 和 height 这几个以像素为单位的只读属性描述整个矩形的位置和大小。除了 width 和 height 以外的属性是相对于视图窗口的左上角来计算的。


```JavaScript


const isInContainer = (el, container) => {
  const elRect = el.getBoundingClientRect();
  const containerRect = container.getBoundingClientRect();

  // 判断是否在视窗内
  return elRect.bottom > containerRect.top &&
          elRect.top < containerRect.bottom &&
          elRect.left < containerRect.right &&
          el.right > containerRect.left;
}

const changeImg = (imgs) => {
  imgs.src = imgs['data-src'];
}

const imgs = (boxDom.childNodes || []).filter(value => value.nodeType === 3);
const onScroll = () => {
  // 监听，并且，如果在范围内，之间替换
  imgs.forEach(value => {
    const inView = isInContainer(value, window);
    if (inView) {
      changeImg(value);
    }
  })
}
window.addEventListener('scroll', onScroll);

```

## 

存在一点问题的代码

```JavaScript

// 图片懒加载
const lazyload = () => {
  // 获取所有的图片列表
  const imgs = document.getElementsByClassName('img');
  const len = imgs.length;

  return () => {
    // 获取可见高度
    const seeHeight = document.documentElement.clientHeight;
    // 获取滚动的高度
    const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;

    for(var i = n; i < len; i++) {
      // 如果 当前图片的 偏移高度属于这个里面
      // 应该还有一个设置，应该是图片在这个视框里面
      // 所以这个应该是有问题的
      if(imgs[i].offsetTop < seeHeight + scrollTop) {
        // 进行替换
        if(imgs[i].getAttribute('src') === 'images/loading.gif') {
          imgs[i].src = imgs[i].getAttribute('data-src');
        }
        n = n + 1;
      }
    }
  }
}

var loadImages = lazyload();
loadImages();          // 初始化首页的页面图片
// 监听 scroll ， 同时添加防抖
window.addEventListener('scroll', debounce(loadImages, 500), false);

```